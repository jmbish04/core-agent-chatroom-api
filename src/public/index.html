<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Core Agent Chatroom - Multi-Agent Coordination</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    .subtitle {
      color: #666;
      font-size: 1.1em;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.5em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .connection-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    input, select, button {
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    input {
      flex: 1;
      min-width: 150px;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status.connected {
      background: #10b981;
      color: white;
    }

    .status.disconnected {
      background: #ef4444;
      color: white;
    }

    .status.connecting {
      background: #f59e0b;
      color: white;
    }

    .messages {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      border: 1px solid #e0e0e0;
    }

    .message {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 6px;
      background: white;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .message.system {
      border-left-color: #10b981;
      background: #f0fdf4;
    }

    .message.error {
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .message.file_locked {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }

    .message-time {
      color: #666;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .message-type {
      color: #667eea;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .message-content {
      color: #333;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .chat-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .chat-input {
      flex: 1;
    }

    .info-grid {
      display: grid;
      gap: 15px;
    }

    .info-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }

    .info-label {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 5px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      color: #333;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 10px;
    }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
    }

    .tab.active {
      background: #667eea;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .quick-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .quick-actions button {
      background: #764ba2;
      font-size: 12px;
      padding: 8px 15px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .agents-list {
      list-style: none;
    }

    .agent-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .agent-name {
      font-weight: 600;
      color: #667eea;
    }

    .agent-id {
      font-size: 11px;
      color: #666;
      font-family: 'Courier New', monospace;
    }

    .locks-list {
      list-style: none;
    }

    .lock-item {
      padding: 10px;
      background: #fffbeb;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #f59e0b;
    }

    .lock-file {
      font-weight: 600;
      color: #f59e0b;
      font-family: 'Courier New', monospace;
      margin-bottom: 5px;
    }

    .lock-info {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ü§ñ Core Agent Chatroom</h1>
      <p class="subtitle">Multi-Agent Coordination via WebSockets with File Lock Management</p>
    </header>

    <div class="grid">
      <div class="card">
        <h2>üîå Connection</h2>
        <div class="connection-controls">
          <input type="text" id="agentName" placeholder="Agent Name" value="Agent-1">
          <input type="text" id="roomId" placeholder="Room ID" value="default">
          <button id="connectBtn" onclick="connect()">Connect</button>
          <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        </div>
        <div>
          <span class="status disconnected" id="status">Disconnected</span>
        </div>

        <div class="stats">
          <div class="stat-box">
            <div class="stat-value" id="messageCount">0</div>
            <div class="stat-label">Messages</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="agentCount">0</div>
            <div class="stat-label">Agents</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="lockCount">0</div>
            <div class="stat-label">Locks</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìä Room Info</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">WebSocket URL</div>
            <div class="info-value" id="wsUrl">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Your Agent ID</div>
            <div class="info-value" id="agentId">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Room ID</div>
            <div class="info-value" id="currentRoom">-</div>
          </div>
        </div>

        <h3 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">üë• Active Agents</h3>
        <ul class="agents-list" id="agentsList">
          <li style="color: #666; font-style: italic;">No agents connected</li>
        </ul>

        <h3 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">üîí Active Locks</h3>
        <ul class="locks-list" id="locksList">
          <li style="color: #666; font-style: italic;">No active locks</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <h2>üí¨ Messages & Events</h2>
      <div class="messages" id="messages"></div>
      <div class="chat-controls">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." disabled>
        <button id="sendBtn" onclick="sendChat()" disabled>Send</button>
      </div>
      <div class="quick-actions">
        <button onclick="lockFile()">üîí Lock File</button>
        <button onclick="unlockFile()">üîì Unlock File</button>
        <button onclick="queryHistory()">üìú Query History</button>
        <button onclick="queryLocks()">üîç Query Locks</button>
        <button onclick="sendHelp()">‚ùì Get Help</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üìñ Quick Start Guide</h2>
        <div class="tabs">
          <button class="tab active" onclick="showTab('usage')">Usage</button>
          <button class="tab" onclick="showTab('mcp')">MCP Integration</button>
          <button class="tab" onclick="showTab('api')">API Reference</button>
        </div>

        <div id="usage" class="tab-content active">
          <h3 style="margin-bottom: 10px;">Basic Usage</h3>
          <ol style="line-height: 1.8; margin-left: 20px;">
            <li>Enter your agent name and room ID</li>
            <li>Click "Connect" to join the room</li>
            <li>Send messages to coordinate with other agents</li>
            <li>Use file locks to prevent duplicate file creation</li>
            <li>Query D1 database for history and active locks</li>
          </ol>

          <h3 style="margin: 20px 0 10px;">File Lock Example</h3>
          <div class="code-block">// Lock a file before creating it
ws.send(JSON.stringify({
  type: 'file_lock',
  filePath: '/src/newFile.ts',
  lockType: 'create'
}));

// Wait for confirmation, then create file
// After done, unlock
ws.send(JSON.stringify({
  type: 'file_unlock',
  filePath: '/src/newFile.ts'
}));</div>
        </div>

        <div id="mcp" class="tab-content">
          <h3 style="margin-bottom: 10px;">MCP (Model Context Protocol) Integration</h3>
          <p style="margin-bottom: 15px; line-height: 1.6;">
            Use this service as an MCP tool to enable agent-to-agent coordination:
          </p>

          <h4 style="margin: 15px 0 10px;">Connection URL</h4>
          <div class="code-block" id="mcpWsUrl">wss://YOUR-WORKER.workers.dev/ws/{roomId}?agentId={id}&agentName={name}</div>

          <h4 style="margin: 15px 0 10px;">Example Configuration</h4>
          <div class="code-block">{
  "mcpServers": {
    "agent-coordination": {
      "command": "node",
      "args": ["./mcp-websocket-client.js"],
      "env": {
        "WS_URL": "wss://YOUR-WORKER.workers.dev/ws/default",
        "AGENT_ID": "agent-1",
        "AGENT_NAME": "CodeAgent"
      }
    }
  }
}</div>
        </div>

        <div id="api" class="tab-content">
          <h3 style="margin-bottom: 10px;">WebSocket API</h3>

          <h4 style="margin: 15px 0 10px;">Message Types</h4>
          <ul style="line-height: 1.8; margin-left: 20px;">
            <li><strong>chat</strong> - Send a chat message</li>
            <li><strong>file_lock</strong> - Request a file lock</li>
            <li><strong>file_unlock</strong> - Release a file lock</li>
            <li><strong>query</strong> - Query D1 database</li>
            <li><strong>help</strong> - Get help information</li>
            <li><strong>ping</strong> - Keep connection alive</li>
          </ul>

          <h4 style="margin: 15px 0 10px;">HTTP Endpoints</h4>
          <ul style="line-height: 1.8; margin-left: 20px;">
            <li><strong>GET /</strong> - This interface</li>
            <li><strong>GET /ws/:roomId</strong> - WebSocket endpoint</li>
            <li><strong>GET /api/room/:roomId/info</strong> - Room info</li>
            <li><strong>GET /api/room/:roomId/history</strong> - Message history</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <h2>üöÄ Deployment Instructions</h2>
        <h3 style="margin-bottom: 10px;">1. Install Dependencies</h3>
        <div class="code-block">npm install</div>

        <h3 style="margin: 15px 0 10px;">2. Create D1 Database</h3>
        <div class="code-block">npx wrangler d1 create chatroom-db</div>
        <p style="margin: 10px 0; font-size: 14px; color: #666;">
          Copy the database_id from the output and update wrangler.toml
        </p>

        <h3 style="margin: 15px 0 10px;">3. Run Migrations</h3>
        <div class="code-block">npm run migrate</div>

        <h3 style="margin: 15px 0 10px;">4. Deploy to Cloudflare</h3>
        <div class="code-block">npm run deploy</div>

        <h3 style="margin: 15px 0 10px;">5. Test Locally</h3>
        <div class="code-block">npm run dev</div>

        <p style="margin-top: 15px; padding: 15px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #10b981;">
          <strong>‚úÖ No Authentication Required</strong><br>
          This service is designed for internal agent coordination and does not require authentication.
          Deploy it on a private network or use Cloudflare Access for security.
        </p>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    let agentId = null;
    let messageCount = 0;
    let agents = new Map();
    let locks = new Map();

    function updateStatus(status, className) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = status;
      statusEl.className = 'status ' + className;
    }

    function connect() {
      const agentName = document.getElementById('agentName').value || 'Agent-1';
      const roomId = document.getElementById('roomId').value || 'default';
      agentId = 'agent-' + Date.now();

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = protocol + '//' + window.location.host + '/ws/' + roomId +
                    '?agentId=' + agentId + '&agentName=' + encodeURIComponent(agentName);

      document.getElementById('wsUrl').textContent = wsUrl;
      document.getElementById('agentId').textContent = agentId;
      document.getElementById('currentRoom').textContent = roomId;

      updateStatus('Connecting...', 'connecting');

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        updateStatus('Connected', 'connected');
        document.getElementById('connectBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        addMessage('System', 'Connected to room: ' + roomId, 'system');
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleMessage(msg);
        } catch (e) {
          console.error('Failed to parse message:', e);
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        addMessage('Error', 'WebSocket error occurred', 'error');
      };

      ws.onclose = () => {
        updateStatus('Disconnected', 'disconnected');
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
        document.getElementById('chatInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
        addMessage('System', 'Disconnected from room', 'system');
        agents.clear();
        locks.clear();
        updateAgentsList();
        updateLocksList();
      };
    }

    function disconnect() {
      if (ws) {
        ws.close();
        ws = null;
      }
    }

    function handleMessage(msg) {
      messageCount++;
      document.getElementById('messageCount').textContent = messageCount;

      switch (msg.type) {
        case 'welcome':
          addMessage('System', 'Welcome! ' + JSON.stringify(msg.data.help.commands.length) + ' commands available. Type help for info.', 'system');
          break;
        case 'chat':
          addMessage(msg.data.agentName || msg.data.agentId, msg.data.content, 'chat');
          break;
        case 'agent_joined':
          agents.set(msg.data.agentId, msg.data);
          addMessage('System', msg.data.agentName + ' joined (' + msg.data.totalAgents + ' agents)', 'system');
          updateAgentsList();
          updateStats();
          break;
        case 'agent_left':
          agents.delete(msg.data.agentId);
          addMessage('System', msg.data.agentName + ' left (' + msg.data.totalAgents + ' agents)', 'system');
          updateAgentsList();
          updateStats();
          break;
        case 'file_locked':
          locks.set(msg.data.filePath, msg.data);
          addMessage('Lock', msg.data.agentName + ' locked: ' + msg.data.filePath + ' (' + msg.data.lockType + ')', 'file_locked');
          updateLocksList();
          updateStats();
          break;
        case 'file_unlocked':
          locks.delete(msg.data.filePath);
          addMessage('Unlock', msg.data.agentName + ' unlocked: ' + msg.data.filePath, 'system');
          updateLocksList();
          updateStats();
          break;
        case 'file_lock_granted':
          addMessage('Success', 'Lock granted for: ' + msg.data.filePath, 'system');
          break;
        case 'file_lock_denied':
          addMessage('Denied', 'Lock denied for: ' + msg.data.filePath + ' - ' + msg.data.reason, 'error');
          break;
        case 'query_response':
          addMessage('Query Result', JSON.stringify(msg.data, null, 2), 'system');
          break;
        case 'help_response':
          addMessage('Help', JSON.stringify(msg.data, null, 2), 'system');
          break;
        case 'error':
          addMessage('Error', msg.data.error, 'error');
          break;
        default:
          addMessage(msg.type, JSON.stringify(msg.data, null, 2), 'system');
      }
    }

    function addMessage(type, content, className = '') {
      const messagesEl = document.getElementById('messages');
      const messageEl = document.createElement('div');
      messageEl.className = 'message ' + className;

      const time = new Date().toLocaleTimeString();
      messageEl.innerHTML =
        '<div class="message-time">' + time + '</div>' +
        '<div class="message-type">' + type + '</div>' +
        '<div class="message-content">' + content + '</div>';

      messagesEl.appendChild(messageEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function sendChat() {
      const input = document.getElementById('chatInput');
      const content = input.value.trim();

      if (!content || !ws) return;

      ws.send(JSON.stringify({
        type: 'chat',
        content: content
      }));

      input.value = '';
    }

    function lockFile() {
      const filePath = prompt('Enter file path to lock:', '/src/example.ts');
      if (!filePath || !ws) return;

      const lockType = prompt('Lock type (read/write/create):', 'write');
      ws.send(JSON.stringify({
        type: 'file_lock',
        filePath: filePath,
        lockType: lockType || 'write'
      }));
    }

    function unlockFile() {
      const filePath = prompt('Enter file path to unlock:', '/src/example.ts');
      if (!filePath || !ws) return;

      ws.send(JSON.stringify({
        type: 'file_unlock',
        filePath: filePath
      }));
    }

    function queryHistory() {
      if (!ws) return;
      ws.send(JSON.stringify({
        type: 'query',
        query: {
          queryType: 'history',
          filters: { limit: 20 }
        }
      }));
    }

    function queryLocks() {
      if (!ws) return;
      ws.send(JSON.stringify({
        type: 'query',
        query: {
          queryType: 'locks'
        }
      }));
    }

    function sendHelp() {
      if (!ws) return;
      ws.send(JSON.stringify({ type: 'help' }));
    }

    function updateAgentsList() {
      const listEl = document.getElementById('agentsList');
      if (agents.size === 0) {
        listEl.innerHTML = '<li style="color: #666; font-style: italic;">No agents connected</li>';
        return;
      }

      listEl.innerHTML = '';
      for (const [id, agent] of agents) {
        const li = document.createElement('li');
        li.className = 'agent-item';
        li.innerHTML =
          '<div>' +
          '<div class="agent-name">' + (agent.agentName || id) + '</div>' +
          '<div class="agent-id">' + id + '</div>' +
          '</div>';
        listEl.appendChild(li);
      }
    }

    function updateLocksList() {
      const listEl = document.getElementById('locksList');
      if (locks.size === 0) {
        listEl.innerHTML = '<li style="color: #666; font-style: italic;">No active locks</li>';
        return;
      }

      listEl.innerHTML = '';
      for (const [filePath, lock] of locks) {
        const li = document.createElement('li');
        li.className = 'lock-item';
        li.innerHTML =
          '<div class="lock-file">' + filePath + '</div>' +
          '<div class="lock-info">Locked by: ' + (lock.agentName || lock.agentId) + ' (' + lock.lockType + ')</div>';
        listEl.appendChild(li);
      }
    }

    function updateStats() {
      document.getElementById('agentCount').textContent = agents.size;
      document.getElementById('lockCount').textContent = locks.size;
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    // Enable Enter key for chat
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat();
      });

      // Update MCP URL with actual host
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const mcpUrl = protocol + '//' + window.location.host + '/ws/{roomId}?agentId={id}&agentName={name}';
      document.getElementById('mcpWsUrl').textContent = mcpUrl;
    });
  </script>
</body>
</html>
